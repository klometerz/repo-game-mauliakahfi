<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kâ™¥M LDR Arena â€” Connect Four</title>
  <meta name="description" content="Connect Four (4-in-a-row) untuk LDR: room online via Firebase atau main lokal di satu device.">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    :root{ 
      --bg:#0b1020; --panel:#111633; --ink:#f8f9ff; --muted:#a1a8c7;
      --p1:#ff6b8b; --p2:#7dd3fc; --accent:#9aa9ff; --accent2:#ffb3c1;
      --win:#34d399; --warn:#fbbf24; --radius:18px; 
      --ring:0 0 0 2px rgba(154,169,255,.28), 0 22px 70px rgba(0,0,0,.45);
    }
    html,body{height:100%;margin:0;background:
      radial-gradient(1200px 800px at 10% -20%,#1e244d 0%,#0b1020 60%),
      radial-gradient(600px 400px at 110% 10%,rgba(255,107,139,.12),transparent 60%);
      color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:28px auto;padding:20px}
    header{display:flex;gap:16px;align-items:center}
    .logo{width:64px;height:64px;border-radius:16px;background:conic-gradient(from 90deg,#ffd6e6,#c8d0ff,#c8fff2,#ffd6e6);display:grid;place-items:center;color:#1b1d3a;font-weight:900;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    h1{margin:0;font-size:22px}
    .sub{color:var(--muted);font-size:14px}

    .panel{margin-top:16px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:16px;box-shadow:var(--ring);backdrop-filter:blur(6px)}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06)}
    select,button,input{accent-color:var(--accent)}
    select,button,input[type="text"]{color:var(--ink);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:10px 12px}
    button{cursor:pointer;transition:transform .12s ease}
    button:hover{transform:translateY(-1px)}

    .board{display:grid;grid-template-columns:repeat(7,1fr);gap:12px;max-width:760px;margin:16px auto; padding:12px;border-radius:20px;border:1px solid rgba(255,255,255,.1);background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02))}
    .col{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:8px;display:grid;grid-template-rows:repeat(6,1fr);gap:8px;cursor:pointer;transition:background .12s}
    .col:hover{background:rgba(255,255,255,.09)}
    .cell{background:#0c1228;border:1px solid rgba(255,255,255,.12);border-radius:999px;display:grid;place-items:center;aspect-ratio:1/1}
    .disc{width:80%;height:80%;border-radius:999px;box-shadow:inset 0 6px 12px rgba(0,0,0,.35)}
    .p1{background:radial-gradient(circle at 30% 30%,#ff9ab0,var(--p1))}
    .p2{background:radial-gradient(circle at 30% 30%,#bfe8ff,var(--p2))}
    .drop{animation:fall .35s ease-out}
    @keyframes fall{from{transform:translateY(-320%)}to{transform:translateY(0)}}
    .hint{outline:2px dashed rgba(255,255,255,.28)}
    .winmark{box-shadow:0 0 0 3px rgba(52,211,153,.95), 0 0 22px rgba(52,211,153,.6)}

    .side{display:grid;gap:12px;max-width:760px;margin:0 auto}
    .chip{display:inline-flex;gap:8px;align-items:center;background:rgba(255,255,255,.06);border-radius:999px;padding:6px 10px;border:1px solid rgba(255,255,255,.12)}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.15)}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}

    .footer{margin-top:10px;color:var(--muted);font-size:13px}
    .note{color:#9fe0ff}

    .turndot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px;box-shadow:0 0 0 3px rgba(255,255,255,.08)}
    .p1dot{background:var(--p1)} .p2dot{background:var(--p2)}

    /* Win FX */
    .fx{pointer-events:none;position:fixed;inset:0;overflow:hidden}
    .heart{position:absolute;will-change:transform,opacity;animation:floatDown 1.6s linear forwards}
    @keyframes floatDown{from{transform:translateY(-10vh) scale(.8) rotate(0);opacity:1}to{transform:translateY(110vh) scale(1.15) rotate(360deg);opacity:0}}
    .banner{position:fixed;top:10%;left:50%;transform:translateX(-50%);background:rgba(17,22,51,.7);border:1px solid rgba(255,255,255,.12);padding:10px 16px;border-radius:999px;font-weight:700;display:none}
    .banner.show{display:inline-flex}

    /* Mini Chat */
    .chat{max-width:760px;margin:12px auto 0;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05)}
    .chat-header{padding:10px 14px;font-weight:600;color:var(--muted);border-bottom:1px solid rgba(255,255,255,.08)}
    .chat-log{max-height:220px;overflow:auto;padding:10px 12px;display:flex;flex-direction:column;gap:8px}
    .bubble{max-width:70%;padding:8px 10px;border-radius:14px;line-height:1.35}
    .bubble.me{align-self:flex-end;background:linear-gradient(180deg,rgba(154,169,255,.35),rgba(154,169,255,.18));border:1px solid rgba(154,169,255,.45)}
    .bubble.other{align-self:flex-start;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
    .meta{font-size:11px;opacity:.8;margin-top:3px}
    .chat-input{display:flex;gap:8px;padding:10px 12px;border-top:1px solid rgba(255,255,255,.08)}
    .chat-input input{flex:1}

    @media (max-width: 640px){ .board{gap:10px} .col{gap:6px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">Kâ™¥M</div>
      <div>
        <h1>Connect Four â€” <span style="font-weight:600;letter-spacing:.3px">Kahfi â™¥ Maulia</span> (LDR)</h1>
        <div class="sub">Main berdua dari jarak jauh (room online) atau lokal 1 device. Giliran bergantian, 4 sejajar menang. ðŸ’™</div>
      </div>
    </header>

    <div class="panel">
      <div class="controls">
        <label class="pill">Mode:
          <select id="mode">
            <option value="local">Lokal (1 device)</option>
            <option value="remote">Remote (LDR via Room)</option>
          </select>
        </label>
        <span class="pill" id="youAre" title="Identitas pemain"></span>
        <span class="pill">P1: <input id="name1" type="text" value="Kahfi" style="width:120px"></span>
        <span class="pill">P2: <input id="name2" type="text" value="Maulia" style="width:120px"></span>
        <button id="btnApplyNames">Apply Nama</button>
        <button id="btnNew">Game Baru</button>
        <button id="btnReset">Reset Papan</button>
        <span class="pill">Ukuran: 
          <select id="size">
            <option value="6x7">6Ã—7 (klasik)</option>
            <option value="5x6">5Ã—6 (cepat)</option>
            <option value="7x8">7Ã—8 (panjang)</option>
          </select>
        </span>
      </div>

      <div class="controls" id="remoteCtl" style="display:none">
        <span class="pill">Room ID: <input id="roomId" type="text" placeholder="contoh: KM123" style="width:120px"> <button id="btnCreate">Create</button> <button id="btnJoin">Join</button></span>
        <button id="btnCopyLink">Copy Link</button>
        <span class="pill">Status: <span id="status">offline</span></span>
      </div>

      <div class="row" style="justify-content:center;margin-top:8px">
        <span class="chip"><span class="badge">Giliran</span> <span id="turn">-</span></span>
        <span class="chip"><span class="badge">Skor</span> P1:<b id="s1">0</b> Â· P2:<b id="s2">0</b></span>
        <span class="chip"><span class="badge">Pemain</span> <span id="pnames">-</span></span>
      </div>

      <div id="board" class="board"></div>
      <div id="fx" class="fx"></div>
      <div id="banner" class="banner">ðŸŽ‰ Selamat! <span id="winnerName"></span></div>

      <div class="chat">
        <div class="chat-header">Mini Chat â€” Kahfi â™¥ Maulia</div>
        <div id="chatLog" class="chat-log"></div>
        <div class="chat-input">
          <input id="chatInput" type="text" placeholder="Kirim pesanâ€¦" maxlength="300">
          <button id="btnSendChat">Kirim</button>
        </div>
      </div>

      <div class="side">
        <div class="chip"><span class="badge">Tips</span> Hover kolom untuk lihat posisi jatuh. Klik untuk jatuhkan bidak.</div>
        <div class="chip"><span class="badge">Catatan</span> Di mode Remote, hanya pemain yang gilirannya berjalan yang bisa klik.</div>
      </div>

      
  </div>

  <!-- Firebase (Compat SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  // ======= FIREBASE CONFIG (ISI DENGAN PUNYAMU) =======
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyBUNrgUB_GKgNgneNdh58L2ulwBKcxg6Z4",
    authDomain: "repo-game.firebaseapp.com",
    databaseURL: "https://repo-game-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "repo-game",
    storageBucket: "repo-game.firebasestorage.app",
    messagingSenderId: "282978146724",
    appId: "1:282978146724:web:ea2d3a9f932be3a7f94931",
    measurementId: "G-LC9XT7L4GH"
  };
  // ================================================

  let fb = { app:null, db:null, uid:null, ready:false };
  function initFirebase(){
    try{
      if(!FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.apiKey.startsWith('YOUR_')) return; // skip if not configured
      fb.app = firebase.initializeApp(FIREBASE_CONFIG);
      fb.db = firebase.database();
      firebase.auth().signInAnonymously().then(cred=>{ fb.uid = cred.user.uid; fb.ready=true; setStatus('online'); }).catch(()=>{ setStatus('auth-failed'); });
    }catch(e){ console.warn('Firebase init failed', e); }
  }

  // ======= GAME LOGIC =======
  const el = id=>document.getElementById(id);
  const boardEl = el('board');
  let ROWS=6, COLS=7;
  let board=[], turn=1, winner=0, lock=false; // 0 empty, 1 P1, 2 P2
  let score={1:0,2:0};
  let mode='local';
  let myRole=null; // 'p1' or 'p2' in remote
  let room=null; // room id
  let roomRef=null; // firebase ref
  let unsub=null; // listener
  let names={1: localStorage.getItem('km_name1')||'Kahfi', 2: localStorage.getItem('km_name2')||'Maulia'};
  let lastMove=null, celebrated=false; 
  let chatRef=null;

  function newBoard(){ board = Array.from({length:ROWS}, ()=> Array(COLS).fill(0)); winner=0; lock=false; lastMove=null; celebrated=false; }

  function setSize(str){ const [r,c]=str.split('x').map(x=>+x); ROWS=r; COLS=c; newBoard(); buildUI(); }

  function buildUI(){
    boardEl.innerHTML='';
    boardEl.style.gridTemplateColumns = `repeat(${COLS},1fr)`;
    for(let c=0;c<COLS;c++){
      const col = document.createElement('div'); col.className='col'; col.dataset.col=c;
      col.addEventListener('mouseenter',()=> hint(c,true));
      col.addEventListener('mouseleave',()=> hint(c,false));
      col.addEventListener('click',()=> handleMove(c));
      for(let r=0;r<ROWS;r++){
        const cell = document.createElement('div'); cell.className='cell'; cell.dataset.r=r; cell.dataset.c=c; col.appendChild(cell);
      }
      boardEl.appendChild(col);
    }
    render();
  }

  function hint(c,on){ if(winner) return; const r = dropRow(c); if(r<0) return; const cell = qCell(r,c); cell.classList.toggle('hint', on); }
  function qCell(r,c){ return boardEl.children[c].children[r]; }

  function dropRow(c){ for(let r=ROWS-1;r>=0;r--) if(board[r][c]===0) return r; return -1; }

  function handleMove(c){
    if(lock||winner) return;
    if(mode==='remote' && !canIMove()) return;
    const r = dropRow(c); if(r<0) return; // full
    board[r][c]=turn; lastMove={r,c}; const winLine = checkWin(r,c,turn);
    turn = (turn===1?2:1);
    render(winLine);
    if(mode==='remote' && roomRef) saveState();
  }

  function render(winLine){
    for(let c=0;c<COLS;c++) for(let r=0;r<ROWS;r++){
      const cell = qCell(r,c); cell.classList.remove('hint');
      cell.innerHTML=''; const v = board[r][c]; if(v){ const d=document.createElement('div'); d.className='disc '+(v===1?'p1':'p2'); if(lastMove && r===lastMove.r && c===lastMove.c) d.classList.add('drop'); cell.appendChild(d); }
      cell.classList.remove('winmark');
    }
    if(winLine){ winLine.forEach(([rr,cc])=> qCell(rr,cc).classList.add('winmark')); }
    const tname = winner? (winner===-1?'Seri': (names[winner]|| (winner===1?'P1':'P2')) + ' MENANG') : ((turn===1?`<span class="turndot p1dot"></span>${names[1]} (Merah)`:`<span class="turndot p2dot"></span>${names[2]} (Kuning)`));
    el('turn').innerHTML = tname;
    el('s1').textContent = score[1]; el('s2').textContent = score[2];
    const my = myRole? (myRole==='p1'?names[1]:names[2]) : '-';
    el('youAre').textContent = mode==='remote'? `Kamu: ${my}` : 'Lokal (P1 vs P2)';
    el('pnames').textContent = `${names[1]} vs ${names[2]}`;
    if(winner && !celebrated){ celebrate(winner); celebrated=true; }
  }

  function checkWin(r,c,p){
    function line(dr,dc){ let arr=[[r,c]]; let rr=r+dr, cc=c+dc; while(inb(rr,cc)&&board[rr][cc]===p){arr.push([rr,cc]); rr+=dr; cc+=dc;} rr=r-dr; cc=c-dc; while(inb(rr,cc)&&board[rr][cc]===p){arr.unshift([rr,cc]); rr-=dr; cc-=dc;} return arr; }
    function inb(rr,cc){ return rr>=0&&rr<ROWS&&cc>=0&&cc<COLS; }
    const dirs=[[1,0],[0,1],[1,1],[1,-1]]; for(const [dr,dc] of dirs){ const arr=line(dr,dc); if(arr.length>=4){ winner=p; score[p]++; lock=true; return arr.slice(0,4); } }
    // draw?
    if(board.every(row=> row.every(v=>v!==0))){ winner=-1; lock=true; }
    return null;
  }

  function resetBoard(){ newBoard(); render(); }
  function newGame(){ score={1:0,2:0}; turn=1; newBoard(); render(); if(mode==='remote'&&roomRef) saveState(true); }

  // ======= REMOTE (Firebase) =======
  function canIMove(){ if(!myRole) return false; return (turn===1 && myRole==='p1') || (turn===2 && myRole==='p2'); }
  function setStatus(s){ el('status').textContent = s; }

  function roomPath(id){ return `rooms/${id}`; }

  async function createRoom(){ if(!fb.ready){ alert('Firebase belum siap/konfigurasi kosong.'); return; }
    const id = (el('roomId').value || genId()); el('roomId').value=id; room=id; myRole='p1'; turn=1; newBoard();
    roomRef = fb.db.ref(roomPath(id));
    await roomRef.set({ board, turn, score, players:{ p1: fb.uid || 'p1', p2: '' }, ts: Date.now(), displayNames:{ p1:names[1], p2:names[2] } });
    attachListener(); attachChat(); setStatus('room-created'); updateNames(); render();
  }

  async function joinRoom(){ if(!fb.ready){ alert('Firebase belum siap/konfigurasi kosong.'); return; }
    const id = el('roomId').value.trim(); if(!id){ alert('Masukkan Room ID.'); return; }
    room=id; roomRef = fb.db.ref(roomPath(id));
    const snap = await roomRef.get(); if(!snap.exists()){ alert('Room tidak ditemukan.'); return; }
    const data = snap.val();
    if(!data.players.p1){ myRole='p1'; await roomRef.child('players/p1').set(fb.uid||'p1'); }
    else if(!data.players.p2){ myRole='p2'; await roomRef.child('players/p2').set(fb.uid||'p2'); }
    else { myRole=null; alert('Room penuh. Kamu akan jadi penonton.'); }
    attachListener(); attachChat(); setStatus('joined'); updateNames();
  }

  function attachListener(){ if(unsub) roomRef.off('value', unsub); unsub = roomRef.on('value', (snap)=>{
      const v = snap.val(); if(!v) return;
      board = v.board; turn = v.turn; score = v.score||score; updateNames(v.players, v.displayNames); render();
    });
  }

  function saveState(reset=false){ if(!roomRef) return; roomRef.update({ board, turn, score, ts: Date.now(), reset: !!reset, displayNames:{ p1:names[1], p2:names[2] } }); }

  function updateNames(players, dnames){ const dn = dnames || {}; if(dn.p1||dn.p2){ el('pnames').textContent = `${dn.p1||names[1]} vs ${dn.p2||names[2]}`; } else { el('pnames').textContent = `${names[1]} vs ${names[2]}`; } }
  const short = (s)=> (s||'').toString().slice(0,6);

  function genId(){ const a='KMA1234567890'; let r=''; for(let i=0;i<6;i++) r+=a[Math.floor(Math.random()*a.length)]; return r; }

  function copyLink(){ if(!room){ alert('Belum ada Room. Create dulu.'); return; } const url = location.origin+location.pathname+`#room=${room}`; navigator.clipboard.writeText(url).then(()=> alert('Link disalin. Kirim ke pasangan.')); }

  // ======= INIT & EVENTS =======
  function applyMode(){ mode = el('mode').value; el('remoteCtl').style.display = (mode==='remote')? 'flex':'none'; myRole = null; room=null; detachChat(); setStatus( mode==='remote' ? (fb.ready?'online':'offline') : 'local' ); newGame(); }

  el('mode').addEventListener('change', applyMode);
  el('btnNew').addEventListener('click', newGame);
  el('btnReset').addEventListener('click', resetBoard);
  el('size').addEventListener('change', e=> setSize(e.target.value));
  el('btnCreate').addEventListener('click', createRoom);
  el('btnJoin').addEventListener('click', joinRoom);
  el('btnCopyLink').addEventListener('click', copyLink);

  // Allow hash-join like #room=KM123
  window.addEventListener('load', ()=>{
    initFirebase();
    setSize('6x7'); 
    applyMode();
    // preload names
    el('name1').value = names[1];
    el('name2').value = names[2];
    const m = new URLSearchParams(location.hash.replace('#','')); const r = m.get('room'); if(r){ el('mode').value='remote'; applyMode(); el('roomId').value=r; }
  });

  // ===== Mini Chat =====
  function attachChat(){ if(!roomRef) return; detachChat(); chatRef = roomRef.child('chat'); chatRef.limitToLast(100).on('child_added', (snap)=>{ appendChat(snap.val()); }); }
  function detachChat(){ if(chatRef){ chatRef.off(); chatRef=null; } if(el('chatLog')) el('chatLog').innerHTML=''; }
  function appendChat(m){ if(!m||!el('chatLog')) return; const box=el('chatLog'); const mine = (fb.uid && m.uid===fb.uid); const wrap=document.createElement('div'); wrap.className='bubble '+(mine?'me':'other'); const text=document.createElement('div'); text.textContent = m.text||''; const meta=document.createElement('div'); meta.className='meta'; const name = m.name || (m.role==='p1'? names[1]: m.role==='p2'? names[2] : 'Guest'); const hh = new Date(m.t||Date.now()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); meta.textContent = `${name} â€¢ ${hh}`; wrap.appendChild(text); wrap.appendChild(meta); box.appendChild(wrap); box.scrollTop = box.scrollHeight; }
  function sendChat(){ const inp=el('chatInput'); if(!inp) return; const text=(inp.value||'').trim(); if(!text) return; if(!(mode==='remote' && fb.ready && roomRef)){ alert('Chat aktif di mode Remote setelah Create/Join room.'); return; } const payload={ t: Date.now(), uid: fb.uid || '', role: myRole || 'guest', name: myRole==='p1'? names[1] : myRole==='p2'? names[2] : 'Guest', text: text.slice(0,300) }; roomRef.child('chat').push(payload); inp.value=''; }

  // ===== FX =====
  function celebrate(p){
    const b = el('banner'); const w = el('winnerName'); if(!b||!w) return;
    w.textContent = `${names[p]} menang!`;
    b.classList.add('show'); setTimeout(()=> b.classList.remove('show'), 1500);
    const fx = el('fx'); if(!fx) return; 
    for(let i=0;i<40;i++){ 
      const h=document.createElement('div'); 
      h.className='heart'; 
      h.textContent = i%2? 'ðŸ’–':'ðŸ’™'; 
      h.style.left = (Math.random()*100)+'%'; 
      h.style.fontSize = (12+Math.random()*14)+'px'; 
      h.style.animationDelay=(Math.random()*0.5)+'s'; 
      fx.appendChild(h); 
      setTimeout(()=> fx.removeChild(h), 1800); 
    }
  }
</script>
</body>
</html>
